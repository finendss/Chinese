local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/CNHM/asg/refs/heads/main/wind%20ui.lua"))()

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local TARGET_LANGUAGE = "zh-CN"
local MAX_TEXT_LENGTH = 500

local translatedCache = {}
local scriptCache = {}

-- 翻译状态
local translationStatus = "等待翻译"
local lastTranslationCount = 0
local totalTranslated = 0

-- 检查是否为英文文本
local function isEnglishText(text)
    if not text or type(text) ~= "string" then return false end
    if not text:match("[A-Za-z]") then
        return false
    end
    if text:match("[\228-\233][\128-\191][\128-\191]") or 
       text:match("[\234-\235][\128-\191][\128-\191]") or 
       text:match("[\227][\128-\191][\128-\191]") then
        return false
    end
    return true
end

-- 检查是否需要跳过翻译
local function shouldSkipTranslation(text)
    if not text or text == "" or translatedCache[text] then
        return true
    end
    if text:match("^%s*$") or 
       text:match("^[0-9%.%s,:/%%%-%=%+%*%(%)%[%]%{%}]+$") then
        translatedCache[text] = text
        return true
    end
    if #text > MAX_TEXT_LENGTH then
        translatedCache[text] = text
        return true
    end
    if not isEnglishText(text) then
        translatedCache[text] = text
        return true
    end
    
    -- 跳过代码关键字和变量名
    if text:match("^[a-zA-Z_][a-zA-Z0-9_]*$") and #text < 30 then
        translatedCache[text] = text
        return true
    end
    
    return false
end

-- 翻译函数
local function translate(text)
    if shouldSkipTranslation(text) then
        return translatedCache[text] or text
    end

    local success, response = pcall(function()
        local url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" .. 
                    TARGET_LANGUAGE .. "&dt=t&q=" .. HttpService:UrlEncode(text)
        return game:HttpGet(url)
    end)

    if success and response then
        local ok, data = pcall(HttpService.JSONDecode, HttpService, response)
        if ok and data and data[1] then
            local translatedText = ""
            for _, segment in ipairs(data[1]) do
                if segment[1] then
                    translatedText = translatedText .. segment[1]
                end
            end
            if translatedText ~= "" and translatedText ~= text then
                translatedCache[text] = translatedText
                print("翻译成功: \"" .. text .. "\" -> \"" .. translatedText .. "\"")
                return translatedText
            end
        end
    end

    translatedCache[text] = text
    return text
end

-- 提取脚本中的英文文本
local function extractEnglishText(scriptCode)
    local texts = {}
    
    -- 匹配双引号字符串
    for match in scriptCode:gsub('\\"', '##ESCAPED_QUOTE##'):gmatch('"(.-)"') do
        local text = match:gsub('##ESCAPED_QUOTE##', '\\"')
        if isEnglishText(text) and not shouldSkipTranslation(text) then
            table.insert(texts, text)
        end
    end
    
    -- 匹配单引号字符串
    for match in scriptCode:gsub("\\'", "##ESCAPED_QUOTE##"):gmatch("'(.-)'") do
        local text = match:gsub("##ESCAPED_QUOTE##", "\\'")
        if isEnglishText(text) and not shouldSkipTranslation(text) then
            table.insert(texts, text)
        end
    end
    
    -- 匹配多行注释
    for match in scriptCode:gmatch("%-%-%[%[(.-)%]%]") do
        if isEnglishText(match) and not shouldSkipTranslation(match) then
            table.insert(texts, match)
        end
    end
    
    -- 匹配单行注释
    for match in scriptCode:gmatch("%-%-%s*(.-)\n") do
        if isEnglishText(match) and not shouldSkipTranslation(match) then
            table.insert(texts, match)
        end
    end
    
    return texts
end

-- 翻译脚本内容
local function translateScript(scriptCode)
    local translatedCode = scriptCode
    
    -- 提取所有需要翻译的文本
    local textsToTranslate = extractEnglishText(scriptCode)
    
    -- 翻译每个文本并替换
    for _, text in ipairs(textsToTranslate) do
        local translatedText = translate(text)
        if translatedText ~= text then
            -- 转义特殊字符用于模式匹配
            local escapedText = text:gsub("([%(%)%.%%%+%-%*%?%[%]%^%$])", "%%%1")
            translatedCode = translatedCode:gsub(escapedText, translatedText)
        end
    end
    
    return translatedCode
end

-- 加载并翻译外部脚本
local function loadTranslatedScript(url, scriptName)
    local success, scriptContent = pcall(function()
        return game:HttpGet(url)
    end)
    
    if success then
        scriptCache[scriptName] = scriptContent
        local translatedScript = translateScript(scriptContent)
        lastTranslationCount = #extractEnglishText(scriptContent)
        totalTranslated = totalTranslated + lastTranslationCount
        translationStatus = "翻译完成"
        
        -- 执行翻译后的脚本
        local success, err = pcall(function()
            loadstring(translatedScript)()
        end)
        
        if success then
            print("脚本翻译并执行成功！翻译了 " .. lastTranslationCount .. " 个文本")
        else
            print("脚本执行失败: " .. tostring(err))
        end
        
        return true
    else
        translationStatus = "加载失败"
        print("无法加载脚本: " .. url)
        return false
    end
end

local Window = WindUI:CreateWindow({
    Title = "XF汉化执行器 ",
    IconThemed = true,
    Icon = "star",
    Author = "FIN Team",
    Size = UDim2.fromOffset(400, 300),
    Transparent = true,
    Theme = "Dark",
})

Window:EditOpenButton({
    Title = "打开执行器",
    Icon = "monitor",
    CornerRadius = UDim.new(0, 6),
    StrokeThickness = 2,
    Color = ColorSequence.new(Color3.fromRGB(30, 30, 30), Color3.fromRGB(255, 255, 255)),
    Draggable = true,
})

-- 创建标签页 - 使用最简单的配置
local MainTab = Window:Tab({
    Title = "脚本翻译",
})

-- 自定义脚本输入
local customScriptUrl = ""
MainTab:Textbox({
    Title = "脚本URL",
    Desc = "输入英文脚本的URL地址",
    Default = "",
    Callback = function(text)
        customScriptUrl = text
    end
})

MainTab:Button({
    Title = "加载并翻译自定义脚本",
    Desc = "从URL加载脚本并翻译为中文",
    Callback = function()
        if customScriptUrl and customScriptUrl ~= "" then
            translationStatus = "翻译中..."
            loadTranslatedScript(customScriptUrl, "custom")
        else
            print("请输入有效的脚本URL")
        end
    end
})

-- 创建管理标签页
local ManageTab = Window:Tab({
    Title = "翻译管理",
})

-- 状态显示
ManageTab:Label({
    Title = "翻译状态",
    Desc = "状态: " .. translationStatus
})

ManageTab:Label({
    Title = "上次翻译数量",
    Desc = "数量: " .. lastTranslationCount
})

ManageTab:Label({
    Title = "总翻译数量",
    Desc = "总计: " .. totalTranslated
})

ManageTab:Label({
    Title = "缓存文本数量",
    Desc = "缓存: " .. (#translatedCache)
})

-- 管理功能
ManageTab:Button({
    Title = "清空翻译缓存",
    Desc = "清除所有翻译缓存",
    Callback = function()
        translatedCache = {}
        print("翻译缓存已清空")
    end
})

ManageTab:Button({
    Title = "查看缓存内容",
    Desc = "显示已翻译的文本",
    Callback = function()
        print("=== 翻译缓存内容 ===")
        local count = 0
        for original, translated in pairs(translatedCache) do
            if original ~= translated then
                print("原文: " .. original)
                print("翻译: " .. translated)
                print("---")
                count = count + 1
            end
        end
        if count == 0 then
            print("缓存为空")
        end
    end
})

-- 创建设置标签页
local SettingsTab = Window:Tab({
    Title = "设置",
})

-- 翻译设置
local maxLength = MAX_TEXT_LENGTH
SettingsTab:Slider({
    Title = "最大文本长度",
    Desc = "设置要翻译的文本最大长度",
    Default = MAX_TEXT_LENGTH,
    Min = 50,
    Max = 1000,
    Callback = function(value)
        maxLength = value
        MAX_TEXT_LENGTH = value
    end
})

-- 测试功能
SettingsTab:Button({
    Title = "测试翻译功能",
    Desc = "测试API是否正常工作",
    Callback = function()
        local testText = "Hello, this is a test message for translation functionality."
        local translated = translate(testText)
        print("测试翻译:")
        print("原文: " .. testText)
        print("结果: " .. translated)
    end
})

-- 界面状态检查
SettingsTab:Button({
    Title = "检查界面状态",
    Desc = "检查所有标签页是否正常加载",
    Callback = function()
        print("=== 界面状态检查 ===")
        print("窗口创建: 成功")
        print("标签页数量: 4")
        print("- 脚本翻译")
        print("- 脚本库") 
        print("- 翻译管理")
        print("- 设置")
        print("所有功能已加载完成")
    end
})

print("XF脚本翻译器加载完成")
print("功能: 将英文脚本翻译为中文后执行")
print("使用方法: 在'脚本翻译'标签页输入URL，或在'脚本库'选择预置脚本")

-- 添加延迟初始化，确保界面完全加载
task.spawn(function()
    task.wait(2)
    print("界面初始化完成，可以使用所有功能")
end)

-- 如果WindUI有初始化完成回调，使用它
if Window.OnLoad then
    Window.OnLoad:Connect(function()
        print("WindUI界面加载完成")
    end)
end
